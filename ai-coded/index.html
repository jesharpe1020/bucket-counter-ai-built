<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="color-scheme" content="light dark" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Buckets" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="apple-touch-icon" href="./icons/icon-192.png" />
    <title>Bucket Counter</title>

    <!-- Early theme init to avoid FOUC -->
    <script>
      (function() {
        try {
          var saved = localStorage.getItem('theme');
          var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          var isDark = saved ? saved === 'dark' : prefersDark;
          if (isDark) document.documentElement.classList.add('dark');
        } catch (_) {}
      })();
    </script>
    <!-- TailwindCSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .no-zoom { touch-action: manipulation; -webkit-user-select: none; user-select: none; }
    </style>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              bg: '#0b0f19',
              fg: '#f9fafb',
              accent: '#22c55e',
              danger: '#ef4444'
            }
          }
        }
      };
    </script>
  </head>
  <body class="min-h-screen antialiased bg-white text-gray-900 dark:bg-bg dark:text-fg" style="padding-top: env(safe-area-inset-top);">
    <main class="mx-auto max-w-md p-4 pb-24">
      <header class="mb-6 flex items-center justify-between">
        <h1 class="text-2xl font-semibold">Bucket Counter</h1>
        <button id="themeToggle" type="button" aria-pressed="false" aria-label="Switch to dark mode" class="rounded border border-black/10 px-3 py-1.5 text-sm font-medium text-gray-700 transition-colors hover:bg-black/5 active:scale-[0.98] dark:border-white/10 dark:text-white/80 dark:hover:bg-white/10">🌙</button>
      </header>

      <section class="mb-8 rounded-lg border border-black/10 bg-black/5 p-4 dark:border-white/10 dark:bg-white/5">
        <div class="text-center">
          <div id="counterValue" class="-m-8 -mt-12 text-[10rem] font-bold tabular-nums">0</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <button id="btnDec" title="Subtract 0.5" class="no-zoom rounded bg-danger px-4 py-3 text-2xl font-semibold text-white transition-colors active:scale-[0.98] hover:bg-danger/80">1/2</button>
          <button id="btnInc" title="Add 0.5" class="no-zoom rounded bg-accent px-4 py-3 text-2xl font-semibold text-white transition-colors active:scale-[0.98] hover:bg-accent/80">1/2</button>
        </div>
      </section>

      <section class="mb-6 rounded-lg border border-black/10 bg-black/5 p-4 dark:border-white/10 dark:bg-white/5">
        <div id="instructionText" class="text-center text-sm text-gray-600 dark:text-white/70">
          Press Start to enable motion detection. Then set Grave and Truck positions.
        </div>
        <div id="calibrationControls" class="mt-2 grid grid-cols-2 gap-3 hidden">
          <button id="btnSetTruck" class="rounded px-3 py-2 shadow-lg font-medium transition-colors active:scale-[0.98] bg-sky-200 text-sky-900 border border-sky-300 hover:shadow-sm dark:bg-white/10 dark:text-white dark:border-white/10 dark:hover:bg-white/20">Set Truck</button>
          <button id="btnSetGrave" class="rounded px-3 py-2 shadow-lg font-medium transition-colors active:scale-[0.98] bg-sky-200 text-sky-900 border border-sky-300 hover:shadow-sm dark:bg-white/10 dark:text-white dark:border-white/10 dark:hover:bg-white/20">Set Grave</button>
        </div>
        <div id="calibrationHeadings" class="mt-3 grid grid-cols-2 gap-3 text-center text-xs text-gray-600 dark:text-white/70 hidden">
          <div>Truck: <span id="truckHeadingLabel">—</span>°</div>
          <div>Grave: <span id="graveHeadingLabel">—</span>°</div>
        </div>
        <div class="mt-4 grid grid-cols-1 gap-3">
          <button id="btnToggle" class="rounded bg-accent px-3 py-2 font-semibold text-white">Start</button>
        </div>
        <div id="resetCalibrationBlock" class="mt-4 hidden">
          <button id="btnResetCalibration" class="w-full rounded border border-black/10 bg-transparent px-3 py-2 text-sm font-medium text-gray-700 transition-colors active:scale-[0.98] hover:bg-black/5 hover:text-gray-900 dark:border-white/10 dark:text-white/70 dark:hover:bg-white/5 dark:hover:text-white/90">Reset Calibration</button>
        </div>
        <div id="statusBlock" class="mt-4 text-sm text-gray-700 dark:text-white/80 hidden">
          <div>Status: <span id="statusText">Idle</span></div>
          <div class="mt-2 text-xs text-gray-500 dark:text-white/60">Heading: <span id="headingText">0</span>°</div>
        </div>
        <div id="permissionsBlock" class="mt-4 hidden">
          <div class="text-xs text-amber-700 dark:text-amber-300">
            Motion and Orientation access is required. If you previously denied, tap Retry. If the prompt does not appear, reload the app and allow access when prompted (you may also need to enable Motion & Orientation in your browser settings).
          </div>
          <div class="mt-2 grid grid-cols-2 gap-3">
            <button id="btnRetryPermissions" class="rounded px-3 py-2 shadow-lg font-medium transition-colors active:scale-[0.98] bg-blue-600 text-white hover:bg-blue-500 dark:bg-white/10 dark:text-white dark:hover:bg-white/20">Retry</button>
            <button id="btnReloadApp" class="rounded px-3 py-2 shadow-lg font-medium transition-colors active:scale-[0.98] bg-gray-200 text-gray-900 hover:bg-gray-300 dark:bg-white/10 dark:text-white dark:hover:bg-white/20">Reload app</button>
          </div>
        </div>
        <div id="newGraveBlock" class="mt-4 hidden">
          <button id="btnNewGrave" class="w-full rounded border px-3 py-2 text-lg transition-colors active:scale-[0.98] bg-amber-100 text-amber-800 border-amber-300 hover:bg-amber-100 shadow-sm dark:bg-transparent dark:border-amber-400/50 dark:text-amber-300 dark:hover:bg-amber-400/10">New Grave</button>
        </div>
      </section>

      <footer class="m-8 text-center text-xs text-gray-500 dark:text-white/50">
        Offline-capable PWA.
      </footer>
    </main>

    <script src="./app.js" defer></script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').catch(() => {});
        });
      }
      // Theme toggle: class-based dark mode with persistence and meta theme sync
      (function() {
        const root = document.documentElement;
        const metaTheme = document.querySelector('meta[name="theme-color"]');
        const btn = document.getElementById('themeToggle');

        const getIsDark = () => root.classList.contains('dark');
        const updateMeta = () => { if (metaTheme) metaTheme.setAttribute('content', getIsDark() ? '#0b0f19' : '#ffffff'); };
        const syncButton = () => {
          if (!btn) return;
          const dark = getIsDark();
          btn.setAttribute('aria-pressed', String(dark));
          btn.setAttribute('aria-label', dark ? 'Switch to light mode' : 'Switch to dark mode');
          btn.textContent = dark ? '☀️' : '🌙';
        };
        const setDark = (enable, persist) => {
          root.classList.toggle('dark', enable);
          if (persist) localStorage.setItem('theme', enable ? 'dark' : 'light');
          updateMeta();
          syncButton();
        };

        // Initial sync after early paint
        updateMeta();
        syncButton();

        // Toggle handler
        if (btn) {
          btn.addEventListener('click', () => setDark(!getIsDark(), true));
        }

        // Respect OS preference if user hasn't chosen manually
        try {
          const mql = window.matchMedia('(prefers-color-scheme: dark)');
          if (!localStorage.getItem('theme')) {
            mql.addEventListener('change', (e) => setDark(e.matches, false));
          }
        } catch (_) {}
      })();
    </script>
  </body>
  <noscript>
    This app requires JavaScript to run.
  </noscript>
  </html>


